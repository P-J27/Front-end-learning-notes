#### å‰è¨€



ä¹‹å‰é¢è¯•é‡åˆ°è¿™æ ·ä¸€ä¸ªé¢˜ç›®ã€‚å…³äºasync/awaitã€promiseå’ŒsetTimeoutçš„æ‰§è¡Œé¡ºåºï¼Œå½“æ—¶æ²¡åšå¯¹ã€‚

åæ¥æŸ¥äº†æŸ¥æ˜¯éå¸¸ç»å…¸çš„é¢˜ç›®ã€‚ä¹Ÿç»™å¤§å®¶è§£ç–‘ç­”æƒ‘ä¸€ä¸‹ï¼Œè¯´å‡ºè‡ªå·±çš„ç†è§£ã€‚

------------



é¢˜ç›®æ˜¯çœ‹ä»£ç å†™ç»“æœã€‚

```js
async function async1() {
	console.log('async1 start');
	await async2();
	console.log('asnyc1 end');
}
async function async2() {
	console.log('async2');
}
console.log('script start');
setTimeout(() => {
	console.log('setTimeOut');
}, 0);
async1();
new Promise(function (reslove) {
	console.log('promise1');
	reslove();
}).then(function () {
	console.log('promise2');
})
console.log('script end');
```

å¤§å®¶å¯ä»¥å…ˆè‡ªå·±åšä¸€åšã€‚çœ‹å’Œç»“æœå¯¹ä¸å¯¹ï¼Œç»“æœå†ä¸‹é¢å…¬å¸ƒã€‚



--------

**æˆ‘ä»¬æ¥åˆ†æè¿™ä¸ªé¢˜ç›®ï¼Œè¦å…ˆçŸ¥é“å‡ ä¸ªæ¦‚å¿µã€‚**

#### EventLoop äº‹ä»¶å¾ªç¯æœºåˆ¶

**JavaScriptçš„äº‹ä»¶åˆ†ä¸¤ç§ï¼Œå®ä»»åŠ¡(macro-task)å’Œå¾®ä»»åŠ¡(micro-task)**

- å®ä»»åŠ¡ï¼šåŒ…æ‹¬æ•´ä½“ä»£ç scriptï¼ŒsetTimeoutï¼ŒsetInterval
- å¾®ä»»åŠ¡ï¼šPromise.then(énew Promise)ï¼Œprocess.nextTick(nodeä¸­)
- äº‹ä»¶çš„æ‰§è¡Œé¡ºåºï¼Œæ˜¯å…ˆæ‰§è¡Œå®ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œè¿™ä¸ªæ˜¯åŸºç¡€ï¼Œä»»åŠ¡å¯ä»¥æœ‰åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼ŒåŒæ­¥çš„è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥çš„è¿›å…¥Event Tableå¹¶æ³¨å†Œå‡½æ•°ï¼Œå¼‚æ­¥äº‹ä»¶å®Œæˆåï¼Œä¼šå°†å›è°ƒå‡½æ•°æ”¾å…¥Event Queueä¸­(å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡æ˜¯ä¸åŒçš„Event Queue)ï¼ŒåŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œä¼šä»Event Queueä¸­è¯»å–äº‹ä»¶æ”¾å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå›è°ƒå‡½æ•°ä¸­å¯èƒ½è¿˜ä¼šåŒ…å«ä¸åŒçš„ä»»åŠ¡ï¼Œå› æ­¤ä¼šå¾ªç¯æ‰§è¡Œä¸Šè¿°æ“ä½œã€‚
- [å…·ä½“å¯ä»¥å‚è€ƒEventLoopè¯¦è§£](https://blog.csdn.net/weixin_43745075/article/details/115461936)

`æ³¨æ„`ï¼š setTimeOutå¹¶ä¸æ˜¯ç›´æ¥çš„æŠŠä½ çš„å›æ‰å‡½æ•°æ”¾è¿›ä¸Šè¿°çš„å¼‚æ­¥é˜Ÿåˆ—ä¸­å»ï¼Œè€Œæ˜¯åœ¨å®šæ—¶å™¨çš„æ—¶é—´åˆ°äº†ä¹‹åï¼ŒæŠŠå›æ‰å‡½æ•°æ”¾åˆ°æ‰§è¡Œå¼‚æ­¥é˜Ÿåˆ—ä¸­å»ã€‚å¦‚æœæ­¤æ—¶è¿™ä¸ªé˜Ÿåˆ—å·²ç»æœ‰å¾ˆå¤šä»»åŠ¡äº†ï¼Œé‚£å°±æ’åœ¨ä»–ä»¬çš„åé¢ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆsetTimeOutä¸ºä»€ä¹ˆä¸èƒ½ç²¾å‡†çš„æ‰§è¡Œçš„é—®é¢˜äº†ã€‚setTimeOutæ‰§è¡Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

> 1. ä¸»è¿›ç¨‹å¿…é¡»æ˜¯ç©ºé—²çš„çŠ¶æ€ï¼Œå¦‚æœåˆ°æ—¶é—´äº†ï¼Œä¸»è¿›ç¨‹ä¸ç©ºé—²ä¹Ÿä¸ä¼šæ‰§è¡Œä½ çš„å›æ‰å‡½æ•° 
> 2. è¿™ä¸ªå›æ‰å‡½æ•°éœ€è¦ç­‰åˆ°æ’å…¥å¼‚æ­¥é˜Ÿåˆ—æ—¶å‰é¢çš„å¼‚æ­¥å‡½æ•°éƒ½æ‰§è¡Œå®Œäº†ï¼Œæ‰ä¼šæ‰§è¡Œ 
>

 ä¸Šé¢æ˜¯æ¯”è¾ƒå®˜æ–¹çš„è§£é‡Šï¼Œè¯´ä¸€ä¸‹è‡ªå·±çš„ç†è§£å§ï¼š

> äº†è§£äº†ä»€ä¹ˆæ˜¯å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ï¼Œå°±å¥½ç†è§£å¤šäº†ï¼Œé¦–å…ˆæ‰§è¡Œ å®ä»»åŠ¡ => å¾®ä»»åŠ¡çš„Event Queue => å®ä»»åŠ¡çš„Event Queue

#### **promiseã€async/await**

1. é¦–å…ˆï¼Œnew Promiseæ˜¯åŒæ­¥çš„ä»»åŠ¡ï¼Œä¼šè¢«æ”¾åˆ°ä¸»è¿›ç¨‹ä¸­å»ç«‹å³æ‰§è¡Œ(å½“åšç«‹å³æ‰§è¡Œå‡½æ•°å»ç†è§£)ã€‚è€Œ`then()å‡½æ•°æ˜¯å¼‚æ­¥ä»»åŠ¡ä¼šæ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­å»`ï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­å»å‘¢ï¼Ÿå½“ä½ çš„promiseçŠ¶æ€ç»“æŸ(å°±æ˜¯æ‰§è¡Œrejectæˆ–è€…resolve)çš„æ—¶å€™ï¼Œå°±ä¼šç«‹å³æ”¾è¿›å¼‚æ­¥é˜Ÿåˆ—ä¸­å»äº†ã€‚
2. å¸¦asyncå…³é”®å­—çš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªpromiseå¯¹è±¡ï¼Œå¦‚æœé‡Œé¢æ²¡æœ‰awaitï¼Œæ‰§è¡Œèµ·æ¥ç­‰åŒäºæ™®é€šå‡½æ•°ï¼›å¦‚æœæ²¡æœ‰awaitï¼Œasyncå‡½æ•°å¹¶æ²¡æœ‰å¾ˆå‰å®³æ˜¯ä¸æ˜¯
3. await å…³é”®å­—è¦åœ¨ async å…³é”®å­—å‡½æ•°çš„å†…éƒ¨ï¼Œawait å†™åœ¨å¤–é¢ä¼šæŠ¥é”™ï¼›awaitå¦‚åŒä»–çš„è¯­æ„ï¼Œå°±æ˜¯åœ¨ç­‰å¾…ï¼Œç­‰å¾…å³ä¾§çš„è¡¨è¾¾å¼å®Œæˆã€‚æ­¤æ—¶çš„`awaitä¼šè®©å‡ºçº¿ç¨‹`ï¼Œ`é˜»å¡asyncå†…åç»­çš„ä»£ç ï¼Œå…ˆå»æ‰§è¡Œasyncå¤–çš„ä»£ç `ã€‚ç­‰å¤–é¢çš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šæ‰§è¡Œé‡Œé¢çš„åç»­ä»£ç ã€‚`å°±ç®—awaitçš„ä¸æ˜¯promiseå¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°`ï¼Œä¹Ÿä¼šç­‰è¿™æ ·æ“ä½œ

#### await ç­‰å¾…çš„æœºåˆ¶

ä¸€èˆ¬æ¥è¯´ï¼Œéƒ½è®¤ä¸º await æ˜¯åœ¨ç­‰å¾…ä¸€ä¸ª async å‡½æ•°å®Œæˆã€‚å‡†ç¡®è¯´ï¼Œawait ç­‰å¾…çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„ æ˜¯ Promise å¯¹è±¡æˆ–è€…å…¶å®ƒå€¼ ã€‚

å› ä¸º async å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥ await å¯ä»¥ç”¨äºç­‰å¾…ä¸€ä¸ª async å‡½æ•°çš„è¿”å›å€¼â€”â€”è¿™ä¹Ÿå¯ä»¥è¯´æ˜¯ await åœ¨ç­‰ async å‡½æ•°ï¼Œä½†è¦æ¸…æ¥šï¼Œå®ƒç­‰çš„å®é™…æ˜¯ä¸€ä¸ªè¿”å›å€¼ ï¼Œawait åé¢å®é™…æ˜¯å¯ä»¥æ¥æ™®é€šå‡½æ•°è°ƒç”¨æˆ–è€…ç›´æ¥é‡çš„ã€‚

await ç­‰åˆ°äº†å®ƒè¦ç­‰çš„ä¸œè¥¿ï¼Œä¸€ä¸ª Promise å¯¹è±¡ï¼Œæˆ–è€…å…¶å®ƒå€¼ï¼Œç„¶åå‘¢ï¼Ÿawait æ˜¯ä¸ªè¿ç®—ç¬¦ï¼Œç”¨äºç»„æˆè¡¨è¾¾å¼ï¼Œawait è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå–å†³äºå®ƒç­‰çš„ä¸œè¥¿ã€‚

å¦‚æœå®ƒç­‰åˆ°çš„ä¸æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå°±æ˜¯å®ƒç­‰åˆ°çš„ä¸œè¥¿ã€‚

å¦‚æœå®ƒç­‰åˆ°çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œ`await å°±å¿™èµ·æ¥äº†ï¼Œå®ƒä¼šé˜»å¡åé¢çš„ä»£ç ï¼Œç­‰ç€ Promise å¯¹è±¡ resolveï¼Œç„¶åå¾—åˆ° resolve çš„å€¼ï¼Œä½œä¸º await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœ`ã€‚è¿™å°±æ˜¯ await å¿…é¡»ç”¨åœ¨ async å‡½æ•°ä¸­çš„åŸå› ã€‚async å‡½æ•°è°ƒç”¨ä¸ä¼šé€ æˆé˜»å¡ï¼Œå®ƒå†…éƒ¨æ‰€æœ‰çš„é˜»å¡éƒ½è¢«å°è£…åœ¨ä¸€ä¸ª Promise å¯¹è±¡ä¸­å¼‚æ­¥æ‰§è¡Œã€‚

**é˜®ä¸€å³°è€å¸ˆçš„è§£é‡Šæˆ‘è§‰å¾—æ›´å®¹æ˜“ç†è§£**ï¼š

> async å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå½“å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€æ—¦é‡åˆ° await å°±ä¼šå…ˆè¿”å›ï¼Œç­‰åˆ°è§¦å‘çš„å¼‚æ­¥æ“ä½œå®Œæˆï¼Œå†æ¥ç€æ‰§è¡Œå‡½æ•°ä½“å†…åé¢çš„è¯­å¥ã€‚ å¯ä»¥ç†è§£ä¸ºï¼Œæ˜¯`è®©å‡ºäº†çº¿ç¨‹ï¼Œè·³å‡ºäº†async å‡½æ•°ä½“`





**å…¬å¸ƒç­”æ¡ˆäº†**âœ¨

```js
script start
async1 start
async2
promise1
script end
asnyc1 end
promise2
setTimeOut
```

![image-20210525112101275](https://gitee.com/p_pj/picgo/raw/master/img/20210525112102.png)

**è§£ææ¥äº†**

1. æ‰§è¡Œconsole.log('script start')ï¼Œè¾“å‡ºscript startï¼›
2. æ‰§è¡ŒsetTimeoutï¼Œæ˜¯ä¸€ä¸ªå¼‚æ­¥åŠ¨ä½œï¼Œæ”¾å…¥å®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼›
   
3. æ‰§è¡Œasync1()ï¼Œè¾“å‡ºasync1 startï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼›
   
4. æ‰§è¡Œasync2()ï¼Œè¾“å‡ºasync2ï¼Œå¹¶è¿”å›äº†ä¸€ä¸ªpromiseå¯¹è±¡ï¼Œawaitè®©å‡ºäº†çº¿ç¨‹ï¼ŒæŠŠè¿”å›çš„promiseåŠ å…¥äº†å¾®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ï¼Œawaitè®©å‡ºçº¿ç¨‹ã€‚åé¢çš„ä»£ç è¢«å µå¡ï¼Œè·³å‡ºasync1å‡½æ•°ã€‚æ‰€ä»¥async1()ä¸‹é¢çš„ä»£ç ä¹Ÿè¦ç­‰å¾…ä¸Šé¢å®Œæˆåç»§ç»­æ‰§è¡Œ;
   
5. æ‰§è¡Œ new Promiseï¼Œè¾“å‡ºpromise1ï¼Œç„¶åå°†resolveæ”¾å…¥å¾®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ï¼›
   
6. æ‰§è¡Œconsole.log('script end')ï¼Œè¾“å‡ºscript endï¼›
   
7. åˆ°æ­¤åŒæ­¥çš„ä»£ç å°±éƒ½æ‰§è¡Œå®Œæˆäº†ï¼Œç„¶åå»å¾®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—é‡Œå»è·å–ä»»åŠ¡
   
8. æ¥ä¸‹æ¥æ‰§è¡Œresolveï¼ˆasync2è¿”å›çš„promiseè¿”å›çš„ï¼‰ï¼Œè¾“å‡ºäº†async1 endã€‚
   
9. ç„¶åæ‰§è¡Œresolveï¼ˆnew Promiseçš„ï¼‰ï¼Œè¾“å‡ºäº†promise2ã€‚
   
10. æœ€åæ‰§è¡ŒsetTimeoutï¼Œè¾“å‡ºäº†settimeoutã€‚

------------

ä¸ªäººç†è§£ï¼Œæ¬¢è¿å¤§ä½¬æŒ‡æ­£ã€‚ğŸ‰